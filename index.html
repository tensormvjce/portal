<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tensor Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&display=swap');
    
    :root {
      --primary: #6366f1;
      --primary-gradient: linear-gradient(120deg, #6366f1, #818cf8);
      --secondary: #10b981;
      --background: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --error: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --info: #3b82f6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      padding: 2.5rem 2rem;
      position: relative;
      overflow-x: hidden;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.7;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 2.5rem;
      grid-template-columns: 1fr 1fr;
    }

    .card {
      background: rgba(30, 41, 59, 0.8);  
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.25);
    }

    .slot-item {
      padding: 1.25rem;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      transition: var(--transition);
      border-left: 4px solid var(--primary);
    } 

    .slot-item:hover {
      background: rgba(51, 65, 85, 0.8);
      transform: scale(1.02);
    }

    .form-card {
      position: sticky;
      top: 2rem;
      height: fit-content;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .title img {
      height: 55px;
      animation: pulse 2s infinite alternate;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }

    .title h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      font-size: 1.8rem;
      background: linear-gradient(120deg, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-muted);
      font-weight: 500;
      transition: var(--transition);
    }

    input, select {
      width: 100%;
      padding: 0.9rem 1rem;
      background: var(--surface-light);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--text);
      transition: var(--transition);
      font-size: 0.95rem;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }

    button {
      width: 100%;
      padding: 1rem;
      background: var(--primary-gradient);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-size: 1rem;
      letter-spacing: 0.5px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px -3px rgba(99, 102, 241, 0.4);
    }

    .alert {
      padding: 1rem;
      background: var(--secondary);
      color: white;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: none;
      animation: slideDown 0.5s ease forwards;
      position: relative;
      overflow: hidden;
    }

    .alert::after {
      content: '';
      position: absolute;
      height: 2px;
      bottom: 0;
      left: 0;
      width: 0;
      background: white;
      animation: progress 3s linear forwards;
    }

    @keyframes slideDown {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }

    .slots-list {
      display: grid;
      gap: 1.5rem;
    }

    .slots-list h3 {
      margin-top: 1rem;
      margin-bottom: 1rem;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      position: relative;
      display: inline-block;
      padding-bottom: 0.5rem;
    }

    .slots-list h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50%;
      height: 3px;
      background: var(--primary);
      border-radius: 3px;
    }

    .slot-details {
      display: grid;
      gap: 0.5rem;
      width: 100%;
    }

    .slot-day {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 1.05rem;
    }

    .slot-date {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .slot-role {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .whatsapp-link {
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }

    .whatsapp-link:hover {
      background: rgba(99, 102, 241, 0.1);
      transform: translateX(2px);
    }

    .whatsapp-link i {
      color: #25D366;
    }

    .no-bookings {
      text-align: center;
      color: var(--text-muted);
      padding: 1.5rem;
      background: rgba(51, 65, 85, 0.3);
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px dashed rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .category-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 0.5rem;
    }

    .category-badge.content {
      background: rgba(14, 165, 233, 0.2);
      color: #38bdf8;
    }

    .category-badge.design {
      background: rgba(249, 115, 22, 0.2);
      color: #fb923c;
    }

    .category-badge.blog {
      background: rgba(101, 163, 13, 0.2);
      color: #84cc16;
    }

    .post-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .form-card {
        position: static;
      }

      body {
        padding: 1.5rem 1rem;
      }

      #adminNav {
        flex-direction: row;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        position: relative;
      }
      
      .hamburger-btn {
        display: block !important;
        order: 2;
      }
      
      .nav-buttons {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--surface);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: none !important;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .nav-buttons.show {
        display: flex !important;
      }
      
      .nav-buttons button {
        width: 100%;
        text-align: center;
        margin: 0;
        padding: 0.75rem 1rem;
      }
      
      #adminLogoutBtn {
        order: 3;
      }
      
      .auto-assign-timer {
        display: none !important;
      }
    }

    @media (min-width: 769px) {
      #adminNav {
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        padding: 1rem 2rem;
      }
      #adminNav button {
        width: auto;
        min-width: 120px;
        text-align: center;
        margin: 0;
      }
      #adminNav div[style*="flex:1"] {
        display: block;
      }
    }

    .credits {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem 0 1rem;
      color: rgba(177, 175, 175, 0.7);
    }

    .credits a {
      text-decoration: none;
      color: rgb(255, 255, 255);
      font-weight: 600;
      position: relative;
      padding: 0 2px;
    }

    .credits a::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 1px;
      background: white;
      transition: width 0.3s ease;
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      background: var(--surface);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      transform: translateX(120%);
      opacity: 0;
      animation: slideIn 0.3s ease forwards;
    }

    button.loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Member Countdown Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-5px); }
      60% { transform: translateY(-3px); }
    }

    #memberCountdownMessage {
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    #memberCountdownMessage.urgent {
      animation: shake 0.5s infinite;
    }

    #memberCountdownMessage.critical {
      animation: bounce 0.8s infinite;
    }
  </style>
</head>
<body>
  <div class="loader-container">
    <div class="loader"></div>
  </div>

  <canvas></canvas>
  
  <div id="mainPortal">
  <div class="container">
    <div class="card form-card">
      <div class="title">
        <img src="logo_white.png" alt="Tensor Logo">
        <h1>Weekly Post Slots</h1>
      </div>

      <div class="alert">
        <i class="fas fa-check-circle"></i> Slot booked successfully!
      </div>

      <form id="slotBookingForm">
        <div class="form-group">
          <label for="userName">Full Name</label>
          <input type="text" id="userName" placeholder="Enter your full name" required>
        </div>

        <div class="form-group">
          <label for="dateRangeSelect">Date Range</label>
          <select id="dateRangeSelect" required>
            <option value="" disabled selected>Select week</option>
              <option value="Aug11-Aug17">Week 1: Aug 11 - Aug 17, 2025</option>
              <option value="Aug18-Aug24">Week 2: Aug 18 - Aug 24, 2025</option>
          </select>
        </div>

        <div class="form-group">
          <label for="daySelect">Preferred Day</label>
          <select id="daySelect" required>
            <option value="" disabled selected>Choose day</option>
          </select>
        </div>

        <div class="form-group">
          <label for="number">WhatsApp Number</label>
          <input type="tel" id="number" placeholder="Include country code (e.g. +91 1234567890)" required>
        </div>

        <div class="form-group">
          <label for="roleSelect">Post Type</label>
          <select id="roleSelect" required>
            <option value="" disabled selected>Select role</option>
          </select>
        </div>

        <button type="submit">
          <span>Book Slot</span>
          <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
        </button>
      </form>
    </div>

    <div class="card">
      <!-- Fun Countdown Message for Members - Inside Current Bookings Card -->
      <div id="memberCountdownMessage" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(16, 185, 129, 0.08)); border: 2px solid rgba(99, 102, 241, 0.2); border-radius: 12px; margin-bottom: 2rem; padding: 1.5rem; position: relative; overflow: hidden;">
        <!-- Decorative Elements -->
        <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(99, 102, 241, 0.1); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -15px; left: -15px; width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1); border-radius: 50%;"></div>
        
        <div style="text-align: center; position: relative; z-index: 1;">
          <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary); margin-bottom: 0.8rem; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
            ‚è∞ <span id="memberTimerDisplay">Loading...</span>
          </div>
          <div style="font-size: 1rem; color: var(--text); margin-bottom: 0.8rem; font-weight: 500;">
            <span id="memberMessageDisplay">üéØ Book your slots before the timer runs out!</span>
          </div>
          <div style="font-size: 0.9rem; color: var(--text-muted); font-style: italic; line-height: 1.4;">
            <span id="memberSubMessageDisplay">‚è≥ Don't wait too long, or the AI will pick for you! ü§ñ</span>
          </div>
        </div>
      </div>
      
      <h2 style="text-align: center; margin-bottom: 2rem; font-family: 'Montserrat', sans-serif;">Current Bookings</h2>
      <div class="slots-list" id="slotAvailability">
        <div class="firebase-loading">
          <div class="spinner"></div>
          <div class="message">Loading bookings...</div>
        </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Admin Login Section (hidden by default) -->
  <div id="adminLoginSection" style="display:none; min-height: 80vh; align-items: center; justify-content: center;">
    <div class="card form-card" style="max-width: 400px; margin: 3rem auto;">
      <div class="title" style="justify-content: center;">
        <h1>Admin Login</h1>
      </div>
      <form id="adminLoginForm">
        <div class="form-group">
          <label for="adminEmail">Email</label>
          <input type="email" id="adminEmail" placeholder="Enter admin email" required>
        </div>
        <div class="form-group">
          <label for="adminPassword">Password</label>
          <input type="password" id="adminPassword" placeholder="Enter password" required>
        </div>
        <button type="submit">
          <span>Sign In</span>
          <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
        </button>
      </form>
    </div>
  </div>
  <!-- Admin Dashboard Section (hidden by default) -->
  <div id="adminDashboardSection" style="display:none;">
    <nav id="adminNav" class="admin-nav" style="background: var(--surface); padding: 1rem 2rem; display: flex; gap: 1rem; align-items: center; border-radius: var(--border-radius); margin: 2rem auto 1rem; max-width: 1200px; flex-wrap: wrap; position: relative;">
      <!-- Navigation Buttons -->
      <div id="navButtons" class="nav-buttons" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <button id="navMembers" style="background: var(--primary-gradient); color: white; border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-weight: 600; cursor: pointer;">Members List</button>
      <button id="navAssign" style="background: var(--surface-light); color: var(--text); border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-weight: 600; cursor: pointer;">Assign Tasks</button>
      <button id="navAutoAssign" style="background: var(--surface-light); color: var(--text); border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-weight: 600; cursor: pointer;">Auto-Assign</button>
        <button id="advanceCycleBtn" style="background: var(--warning); color: white; border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-weight: 600; cursor: pointer;">Next Week</button>
      </div>
      
      <div style="flex:1"></div>
      
      <!-- Auto-Assign Timer Display -->
      <div id="autoAssignTimer" class="auto-assign-timer" style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-right: 1rem;">
        <div style="font-size: 0.8rem; color: var(--secondary); font-weight: 600;">Next Auto-Assign</div>
        <div id="timerDisplay" style="font-size: 0.9rem; color: var(--text); font-weight: 500;">Loading...</div>
      </div>
      
      <!-- Hamburger Menu Button (Mobile) - Top Right -->
      <button id="hamburgerBtn" class="hamburger-btn" style="display: none; background: none; border: none; color: var(--text); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; margin-left: auto;">
        <i class="fas fa-bars"></i>
      </button>
      
      <button id="adminLogoutBtn" style="background: var(--error); color: white; border: none; border-radius: 8px; padding: 0.5rem 1.5rem; font-weight: 600; cursor: pointer;">Logout</button>
    </nav>
    <div id="adminMembersSection" class="container" style="display: block; max-width: 1200px; margin: 0 auto;">
      <div class="card" style="min-width: 300px;">
        <h2 style="margin-bottom: 1rem;">Content Team</h2>
        <ul id="contentTeamList" style="list-style: none; padding: 0;"></ul>
      </div>
      <div class="card" style="min-width: 300px;">
        <h2 style="margin-bottom: 1rem;">Design Team</h2>
        <ul id="designTeamList" style="list-style: none; padding: 0;"></ul>
      </div>
      <div class="card form-card" style="min-width: 300px;">
        <h2 style="margin-bottom: 1rem;">Add Member</h2>
        <form id="addMemberForm">
          <div class="form-group">
            <label for="memberName">Name</label>
            <input type="text" id="memberName" required>
          </div>
          <div class="form-group">
            <label for="memberNumber">WhatsApp Number</label>
            <input type="tel" id="memberNumber" required>
          </div>
          <div class="form-group">
            <label for="memberTeam">Team</label>
            <select id="memberTeam" required>
              <option value="" disabled selected>Select team</option>
              <option value="contentTeam">Content Team</option>
              <option value="designTeam">Design Team</option>
            </select>
          </div>
          <button type="submit">
            <span>Add Member</span>
            <i class="fas fa-plus" style="margin-left: 8px;"></i>
          </button>
        </form>
      </div>
    </div>
    <div id="adminAssignSection" class="container" style="display: none; max-width: 1200px; margin: 0 auto;">
      <div class="card" style="width: 100%;">
        <h2 style="margin-bottom: 1rem;">Assign Tasks</h2>
        <div id="assignTasksList"></div>
      </div>
    </div>
    <div id="adminAutoAssignSection" class="container" style="display: none; max-width: 1200px; margin: 0 auto;">
      <div class="card" style="width: 100%;">
        <h2 style="margin-bottom: 1rem;">Auto-Assign Slots</h2>
        <form id="autoAssignForm" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
          <div class="form-group" style="min-width: 180px;">
            <label for="autoDateRange">Date Range</label>
            <select id="autoDateRange" required>
              <option value="" disabled selected>Select week</option>
              <option value="Aug11-Aug17">Week 1: Aug 11 - Aug 17, 2025</option>
              <option value="Aug18-Aug24">Week 2: Aug 18 - Aug 24, 2025</option>
            </select>
          </div>
          <div class="form-group" style="min-width: 180px;">
            <label for="autoDay">Day</label>
            <select id="autoDay" required>
              <option value="" disabled selected>Choose day</option>
            </select>
          </div>
          <div class="form-group" style="min-width: 180px;">
            <label for="autoRole">Role</label>
            <select id="autoRole" required>
              <option value="" disabled selected>Select role</option>
            </select>
          </div>
          <button type="submit" style="min-width: 150px;">Auto Assign</button>
        </form>
        <div id="autoAssignResult" style="margin-top:2rem;"></div>
        
        <!-- Manual Auto-Assign Trigger -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">
          <h4 style="margin-bottom: 1rem; color: var(--secondary);">Manual Auto-Assign</h4>
          <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
            Use this button to manually trigger auto-assignment for the current cycle. 
            The system will respect all break logic and group prevention rules.
          </p>
          <button id="manualAutoAssignBtn" style="background: var(--secondary); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; transition: var(--transition);">
            <i class="fas fa-magic" style="margin-right: 0.5rem;"></i>
            Run Auto-Assign Now
          </button>
        </div>
      </div>
    </div>
  </div>
      </div>
    </div>
  </div>
  
  <div class="credits">
    <footer>
      <p>Designed and developed by: <a href="https://www.linkedin.com/in/srikar-t-118581286/">Srikar</a> & <a href="https://www.linkedin.com/in/piratla-ankit-rama-datt/">Ankit</a></p>
    </footer>
  </div>

  <div class="toast-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    // Your new Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB-PZMH9kvSziZepwpL2994IV9OZD5Uj-k",
      authDomain: "tensor-portal.firebaseapp.com",
      projectId: "tensor-portal",
      storageBucket: "tensor-portal.appspot.com",
      messagingSenderId: "860387540675",
      appId: "1:860387540675:web:44acbeddd76e6c2e706c76",
      measurementId: "G-P23J5L5DEX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Current active weeks - sliding 2-week window
    let dateRanges = {};
    let currentWeekStart = null; // Track the start of current week
    
    // Function to generate date range for a given week
    function generateDateRange(weekKey) {
      // Parse week key like "Aug11-Aug17" to get start and end dates
      const match = weekKey.match(/([A-Za-z]+)(\d+)-([A-Za-z]+)(\d+)/);
      if (!match) return null;
      
      const startMonth = match[1];
      const startDay = parseInt(match[2]);
      const endMonth = match[3];
      const endDay = parseInt(match[4]);
      const year = 2025; // You can make this dynamic too
      
      const monthMap = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
      };
      
      const startDate = new Date(year, monthMap[startMonth], startDay);
      const endDate = new Date(year, monthMap[endMonth], endDay);
      
      // Find Wednesday and Sunday in this range
      const wednesday = new Date(startDate);
      while (wednesday.getDay() !== 3) { // 3 = Wednesday
        wednesday.setDate(wednesday.getDate() + 1);
      }
      
      const sunday = new Date(startDate);
      while (sunday.getDay() !== 0) { // 0 = Sunday
        sunday.setDate(sunday.getDate() + 1);
      }
      
      return {
        start: startDate,
        end: endDate,
        days: {
          'Wednesday': wednesday,
          'Sunday': {
            date: sunday,
            postType: weekKey.includes('Aug11') || weekKey.includes('Aug18') ? 'text' : 'video' // Alternate format
          }
        }
      };
    }

    // Function to generate week key from start and end dates
    function generateWeekKey(startDate, endDate) {
      const startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
      const startDay = startDate.getDate();
      const endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
      const endDay = endDate.getDate();
      
      return `${startMonth}${startDay}-${endMonth}${endDay}`;
    }

    // Function to generate date range from start and end dates
    function generateDateRangeFromDates(startDate, endDate) {
      // Find Wednesday and Sunday in this range
      const wednesday = new Date(startDate);
      while (wednesday.getDay() !== 3) { // 3 = Wednesday
        wednesday.setDate(wednesday.getDate() + 1);
      }
      
      const sunday = new Date(startDate);
      while (sunday.getDay() !== 0) { // 0 = Sunday
        sunday.setDate(sunday.getDate() + 1);
      }
      
      return {
        start: startDate,
        end: endDate,
        days: {
          'Wednesday': wednesday,
          'Sunday': {
            date: sunday,
            postType: 'video' // Default to video for new weeks
          }
        }
      };
    }
    
    // Function to get current active weeks using sliding window
    async function getCurrentActiveWeeks() {
      try {
        // Get current week start from localStorage or calculate it
        let storedWeekStart = localStorage.getItem('tensorCurrentWeekStart');
        
        if (storedWeekStart) {
          currentWeekStart = new Date(storedWeekStart);
        } else {
          // Calculate current week start (Monday)
          const now = new Date();
          const dayOfWeek = now.getDay();
          const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday = 0, Monday = 1
          currentWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysToMonday);
          localStorage.setItem('tensorCurrentWeekStart', currentWeekStart.toISOString());
        }
        
        // Generate 2 weeks: current week + next week
        dateRanges = {};
        
        // Week 1: Current week (Monday to Sunday)
        const week1Start = new Date(currentWeekStart);
        const week1End = new Date(week1Start);
        week1End.setDate(week1Start.getDate() + 6);
        
        const week1Key = generateWeekKey(week1Start, week1End);
        const week1Range = generateDateRangeFromDates(week1Start, week1End);
        if (week1Range) {
          dateRanges[week1Key] = week1Range;
        }
        
        // Week 2: Next week (Monday to Sunday)
        const week2Start = new Date(week1Start);
        week2Start.setDate(week1Start.getDate() + 7);
        const week2End = new Date(week2Start);
        week2End.setDate(week2Start.getDate() + 6);
        
        const week2Key = generateWeekKey(week2Start, week2End);
        const week2Range = generateDateRangeFromDates(week2Start, week2End);
        if (week2Range) {
          dateRanges[week2Key] = week2Range;
        }
        
        // Update dropdowns with current 2 weeks
        updateWeekDropdowns();
        
        console.log('Current weeks loaded:', Object.keys(dateRanges));
        
      } catch (error) {
        console.error('Error loading current weeks:', error);
        // Fallback to current date-based weeks
        const now = new Date();
        const currentWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const week1Key = generateWeekKey(currentWeekStart, new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));
        const week2Key = generateWeekKey(new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000), new Date(currentWeekStart.getTime() + 13 * 24 * 60 * 60 * 1000));
        
        dateRanges[week1Key] = generateDateRangeFromDates(currentWeekStart, new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));
        dateRanges[week2Key] = generateDateRangeFromDates(new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000), new Date(currentWeekStart.getTime() + 13 * 24 * 60 * 60 * 1000));
        
        updateWeekDropdowns();
      }
    }
    
    // Function to update week dropdowns (only show 2 weeks)
    function updateWeekDropdowns() {
      const weekKeys = Object.keys(dateRanges).sort();
      
      // Update main form dropdown
      const dateRangeSelect = document.getElementById('dateRangeSelect');
      if (dateRangeSelect) {
        dateRangeSelect.innerHTML = '<option value="" disabled selected>Select week</option>';
        weekKeys.forEach((weekKey, index) => {
          const option = document.createElement('option');
          option.value = weekKey;
          option.textContent = `Week ${index + 1}: ${weekKey.replace('-', ' - ')}`;
          dateRangeSelect.appendChild(option);
        });
      }
      
      // Update admin auto-assign dropdown
      const autoDateRange = document.getElementById('autoDateRange');
      if (autoDateRange) {
        autoDateRange.innerHTML = '<option value="" disabled selected>Select week</option>';
        weekKeys.forEach((weekKey, index) => {
          const option = document.createElement('option');
          option.value = weekKey;
          option.textContent = `Week ${index + 1}: ${weekKey.replace('-', ' - ')}`;
          autoDateRange.appendChild(option);
        });
      }
    }
    
    // Function to advance to next week (admin function)
    async function advanceToNextWeek() {
      try {
        // Move current week start forward by 1 week
        if (currentWeekStart) {
          currentWeekStart.setDate(currentWeekStart.getDate() + 7);
          localStorage.setItem('tensorCurrentWeekStart', currentWeekStart.toISOString());
          
          // Reload current weeks
          await getCurrentActiveWeeks();
          
          showToast('Advanced to next week successfully!', 'success');
        } else {
          showToast('No current week start found', 'error');
        }
      } catch (error) {
        console.error('Error advancing to next week:', error);
        showToast('Failed to advance to next week', 'error');
      }
    }

    // Auto-Assign Timer System
    let autoAssignInterval;
    let lastAutoAssignDate = null;

    // Function to get next Sunday 7:00 PM IST
    function getNextSunday7PM() {
      const now = new Date();
      const istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
      const istNow = new Date(now.getTime() + istOffset);
      
      // Find next Sunday
      let nextSunday = new Date(istNow);
      const daysUntilSunday = (7 - nextSunday.getDay()) % 7;
      if (daysUntilSunday === 0 && istNow.getHours() >= 19) {
        // If it's Sunday and past 7 PM, get next Sunday
        nextSunday.setDate(nextSunday.getDate() + 7);
      } else {
        nextSunday.setDate(nextSunday.getDate() + daysUntilSunday);
      }
      
      // Set to 7:00 PM IST
      nextSunday.setHours(19, 0, 0, 0);
      
      // Convert back to UTC
      return new Date(nextSunday.getTime() - istOffset);
    }

    // Function to update countdown timer
    function updateCountdownTimer() {
      const nextSunday7PM = getNextSunday7PM();
      const now = new Date();
      const timeDiff = nextSunday7PM.getTime() - now.getTime();
      
      if (timeDiff <= 0) {
        // Time to auto-assign!
        runAutoAssignForCurrentCycle();
        return;
      }
      
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
      
      // Update admin timer
      const timerDisplay = document.getElementById('timerDisplay');
      if (timerDisplay) {
        if (days > 0) {
          timerDisplay.textContent = `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
          timerDisplay.textContent = `${hours}h ${minutes}m ${seconds}s`;
        } else {
          timerDisplay.textContent = `${minutes}m ${seconds}s`;
        }
      }
      
      // Update member timer and messages
      updateMemberCountdownDisplay(days, hours, minutes, seconds);
    }

    // Function to update member countdown display with fun messages
    function updateMemberCountdownDisplay(days, hours, minutes, seconds) {
      const memberTimerDisplay = document.getElementById('memberTimerDisplay');
      const memberMessageDisplay = document.getElementById('memberMessageDisplay');
      const memberSubMessageDisplay = document.getElementById('memberSubMessageDisplay');
      
      if (!memberTimerDisplay || !memberMessageDisplay || !memberSubMessageDisplay) return;
      
      // Update timer display
      if (days > 0) {
        memberTimerDisplay.textContent = `${days} days, ${hours} hours, ${minutes} minutes`;
      } else if (hours > 0) {
        memberTimerDisplay.textContent = `${hours} hours, ${minutes} minutes, ${seconds} seconds`;
      } else if (minutes > 0) {
        memberTimerDisplay.textContent = `${minutes} minutes, ${seconds} seconds`;
      } else {
        memberTimerDisplay.textContent = `${seconds} seconds`;
      }
      
      // Get the next week (Week 2) that needs filling
      const weekKeys = Object.keys(dateRanges).sort();
      const nextWeekKey = weekKeys.length >= 2 ? weekKeys[1] : 'Next Week';
      
      // Dynamic fun messages based on time remaining
      let mainMessage, subMessage;
      
      if (days > 2) {
        mainMessage = `üéØ Plenty of time to pick your perfect slot for ${nextWeekKey}!`;
        subMessage = "‚è≥ But don't procrastinate too much! üêå";
      } else if (days > 1) {
        mainMessage = `üöÄ Weekend is coming! Book your slots for ${nextWeekKey} now!`;
        subMessage = "‚è∞ The AI is getting restless... ü§ñ";
      } else if (days > 0) {
        mainMessage = `üî• Last day to book ${nextWeekKey}! Don't miss out!`;
        subMessage = "‚ö° The AI is warming up its assignment engine! üöÄ";
      } else if (hours > 12) {
        mainMessage = `‚è∞ Less than a day left to book ${nextWeekKey}!`;
        subMessage = "ü§ñ The AI is preparing to take over!";
      } else if (hours > 6) {
        mainMessage = `‚ö° Only a few hours left to book ${nextWeekKey}!`;
        subMessage = "ü§ñ The AI is getting impatient! ‚ö°";
      } else if (hours > 1) {
        mainMessage = `üö® Final countdown to book ${nextWeekKey}! Book NOW!`;
        subMessage = "ü§ñ The AI is almost ready to assign! üöÄ";
      } else if (minutes > 30) {
        mainMessage = `üí• Less than an hour to book ${nextWeekKey}! Last chance!`;
        subMessage = "ü§ñ The AI is counting down with you! ‚è∞";
      } else if (minutes > 10) {
        mainMessage = `üö® EMERGENCY! Less than 30 minutes to book ${nextWeekKey}!`;
        subMessage = "ü§ñ The AI is getting excited! üéâ";
      } else if (minutes > 1) {
        mainMessage = `üî• FINAL MINUTES to book ${nextWeekKey}! Book now!`;
        subMessage = "ü§ñ The AI is ready to pounce! üêæ";
      } else {
        mainMessage = `üíÄ TOO LATE! The AI is taking over ${nextWeekKey}!`;
        subMessage = "ü§ñ Auto-assignment in progress... üöÄ";
      }
      
      memberMessageDisplay.textContent = mainMessage;
      memberSubMessageDisplay.textContent = subMessage;
      
      // Simple visual urgency indicator
      const countdownCard = document.getElementById('memberCountdownMessage');
      if (countdownCard) {
        countdownCard.className = days > 1 ? 'card' : hours > 6 ? 'card urgent' : 'card critical';
      }
    }

    // Function to run auto-assign for current cycle
    async function runAutoAssignForCurrentCycle() {
      try {
        console.log('Running auto-assign for current cycle...');
        
        // Auto-assign for the NEXT week (week 2) only
        const weekKeys = Object.keys(dateRanges).sort();
        if (weekKeys.length >= 2) {
          const nextWeekKey = weekKeys[1]; // Week 2 is the next week
          const rangeObj = dateRanges[nextWeekKey];
          
          console.log('Auto-assigning for next week:', nextWeekKey);
          
          // Auto-assign for each day and role in the next week
          Object.entries(rangeObj.days).forEach(async ([day, dayObj]) => {
            let roles = [];
            if (day === 'Sunday') {
              roles = ['Content', 'Design'];
            } else if (day === 'Wednesday') {
              roles = ['BlogPost'];
            }
            
            for (const role of roles) {
              await autoAssignForSlot(nextWeekKey, day, role);
            }
          });
        }
        
        // Update last auto-assign date
        const currentDate = new Date();
        localStorage.setItem('lastAutoAssignDate', currentDate.toISOString());
        lastAutoAssignDate = currentDate.toISOString();
        
        showToast('Auto-assignment completed successfully!', 'success');
        
        // Refresh displays
        loadAssignTasks();
        displaySlots();
        
      } catch (error) {
        console.error('Error in auto-assign:', error);
        showToast('Auto-assignment failed', 'error');
      }
    }

    // Function to auto-assign for a specific slot
    async function autoAssignForSlot(range, day, role) {
      try {
        // Fetch members
        let teamType = (role === 'Design') ? 'designTeam' : 'contentTeam';
        const membersSnap = await get(ref(db, `members/${teamType}`));
        const members = membersSnap.exists() ? membersSnap.val() : {};
        
        // Fetch current bookings
        const slotRef = ref(db, `bookings/${range}/${day}/${role}`);
        const bookingsSnap = await get(slotRef);
        const currentBookings = bookingsSnap.exists() ? bookingsSnap.val() : {};
        
        const alreadyAssignedNumbers = new Set(Object.values(currentBookings).map(m => m.number));
        const unassigned = Object.values(members).filter(m => !alreadyAssignedNumbers.has(m.number));
        
        // How many to assign?
        const maxSlots = role === 'BlogPost' ? 1 : 3;
        const toAssign = maxSlots - Object.keys(currentBookings).length;
        
        if (toAssign <= 0) return; // Already filled
        
        // Apply break logic and group prevention (reuse existing logic)
        let availableMembers = unassigned;
        
        // Check for people who worked in the previous week and prevent same group formation
        try {
          const allBookingsRef = ref(db, 'bookings');
          const allBookingsSnapshot = await get(allBookingsRef);
          
          if (allBookingsSnapshot.exists()) {
            const allBookings = allBookingsSnapshot.val();
            
            // Sort weeks chronologically
            const allWeekKeys = Object.keys(allBookings).sort((a, b) => {
              const parseWeekStart = (weekKey) => {
                const match = weekKey.match(/([A-Za-z]+)(\d+)/);
                if (!match) return new Date(0);
                
                const month = match[1];
                const day = parseInt(match[2]);
                const year = 2025;
                
                const monthMap = {
                  'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                  'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                
                return new Date(year, monthMap[month], day);
              };
              
              const dateA = parseWeekStart(a);
              const dateB = parseWeekStart(b);
              return dateA - dateB;
            });
            
            const currentWeekIndex = allWeekKeys.indexOf(range);
            
            if (currentWeekIndex > 0) {
              const previousWeek = allWeekKeys[currentWeekIndex - 1];
              const lastWeekBookings = allBookings[previousWeek];
              const lastWeekWorkers = new Set();
              
              // Collect all people who worked in the previous week
              Object.values(lastWeekBookings).forEach(dayData => {
                Object.values(dayData).forEach(roleData => {
                  Object.values(roleData).forEach(member => {
                    lastWeekWorkers.add(member.number);
                  });
                });
              });
              
              // Filter out people who worked in the previous week
              availableMembers = unassigned.filter(m => !lastWeekWorkers.has(m.number));
              
              // Prevent same group formation from all previous weeks
              if (availableMembers.length >= toAssign) {
                const allPreviousGroups = [];
                
                for (let i = 0; i < currentWeekIndex; i++) {
                  const pastWeek = allWeekKeys[i];
                  const pastWeekBookings = allBookings[pastWeek];
                  
                  Object.entries(pastWeekBookings).forEach(([pastDay, pastDayData]) => {
                    Object.entries(pastDayData).forEach(([pastRole, pastRoleData]) => {
                      const groupMembers = Object.values(pastRoleData);
                      if (groupMembers.length > 0) {
                        allPreviousGroups.push({
                          members: groupMembers,
                          day: pastDay,
                          role: pastRole,
                          week: pastWeek
                        });
                      }
                    });
                  });
                }
                
                if (allPreviousGroups.length > 0) {
                  const sameDayRoleGroups = allPreviousGroups.filter(group => group.day === day && group.role === role);
                  
                  if (sameDayRoleGroups.length > 0) {
                    const allPreviousGroupMembers = new Set();
                    sameDayRoleGroups.forEach(group => {
                      group.members.forEach(member => {
                        allPreviousGroupMembers.add(member.number);
                      });
                    });
                    
                    const availableForDifferentGroup = availableMembers.filter(m => !allPreviousGroupMembers.has(m.number));
                    
                    if (availableForDifferentGroup.length >= toAssign) {
                      availableMembers = availableForDifferentGroup;
                    }
                  }
                }
              }
            }
          }
        } catch (err) {
          console.error('Error checking previous week bookings:', err);
        }
        
        // Randomly pick members
        if (availableMembers.length >= toAssign) {
          const shuffled = availableMembers.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, toAssign);
          
          // Assign them
          for (const member of selected) {
            await push(slotRef, {
              name: member.name,
              number: member.number,
              date: formatDate(dateRanges[range].days[day].date || dateRanges[range].days[day])
            });
          }
        }
        
      } catch (error) {
        console.error(`Error auto-assigning for ${range}/${day}/${role}:`, error);
      }
    }

    // Function to start the auto-assign timer
    function startAutoAssignTimer() {
      // Update timer immediately
      updateCountdownTimer();
      
      // Update timer every second
      autoAssignInterval = setInterval(updateCountdownTimer, 1000);
      
      // Check if it's time to auto-assign every minute
      setInterval(() => {
        const nextSunday7PM = getNextSunday7PM();
        const now = new Date();
        if (now.getTime() >= nextSunday7PM.getTime()) {
          runAutoAssignForCurrentCycle();
        }
      }, 60000); // Check every minute
    }

    // Function to stop the auto-assign timer
    function stopAutoAssignTimer() {
      if (autoAssignInterval) {
        clearInterval(autoAssignInterval);
        autoAssignInterval = null;
      }
    }

    // Function to start member countdown timer (for main portal)
    function startMemberCountdownTimer() {
      // Update timer immediately
      updateMemberCountdownDisplay(0, 0, 0, 0);
      
      // Update timer every second
      setInterval(() => {
        const nextSunday7PM = getNextSunday7PM();
        const now = new Date();
        const timeDiff = nextSunday7PM.getTime() - now.getTime();
        
        if (timeDiff > 0) {
          const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
          
          updateMemberCountdownDisplay(days, hours, minutes, seconds);
        }
      }, 1000);
    }

    // Manual Auto-Assign Button
    const manualAutoAssignBtn = document.getElementById('manualAutoAssignBtn');
    if (manualAutoAssignBtn) {
      manualAutoAssignBtn.addEventListener('click', async () => {
        manualAutoAssignBtn.classList.add('loading');
        manualAutoAssignBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Running...';
        
        try {
          await runAutoAssignForCurrentCycle();
        } catch (error) {
          console.error('Manual auto-assign failed:', error);
          showToast('Manual auto-assign failed', 'error');
        } finally {
          manualAutoAssignBtn.classList.remove('loading');
          manualAutoAssignBtn.innerHTML = '<i class="fas fa-magic" style="margin-right: 0.5rem;"></i>Run Auto-Assign Now';
        }
      });
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    document.getElementById('dateRangeSelect').addEventListener('change', function(e) {
      const rangeKey = e.target.value;
      const daySelect = document.getElementById('daySelect');
      const roleSelect = document.getElementById('roleSelect');
      
      daySelect.innerHTML = '<option value="" disabled selected>Choose day</option>';
      roleSelect.innerHTML = '<option value="" disabled selected>Select role</option>';

      const range = dateRanges[rangeKey];
      for (const [dayName, dayData] of Object.entries(range.days)) {
        const option = document.createElement('option');
        option.value = dayName;
        
        if (dayName === 'Sunday') {
          option.textContent = `${dayName} (${formatDate(dayData.date)}) - ${dayData.postType.toUpperCase()}`;
        } else {
          option.textContent = `${dayName} (${formatDate(dayData)})`;
        }
        
        daySelect.appendChild(option);
      }
    });

    document.getElementById('daySelect').addEventListener('change', function(e) {
      const roleSelect = document.getElementById('roleSelect');
      roleSelect.innerHTML = '<option value="" disabled selected>Select role</option>';

      if (e.target.value === 'Sunday') {
        roleSelect.innerHTML = `
          <option value="Content">Content (3 slots)</option>
          <option value="Design">Design (3 slots)</option>
        `;
      } else if (e.target.value === 'Wednesday') {
        roleSelect.innerHTML = `
          <option value="BlogPost">Blog Post Writer (1 slot)</option>
        `;
      }
    });

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icon = document.createElement('i');
      icon.className = `fas fa-${type === 'success' ? 'check-circle' : 
                          type === 'error' ? 'exclamation-circle' :
                          type === 'warning' ? 'exclamation-triangle' : 'info-circle'}`;
      
      toast.appendChild(icon);
      toast.appendChild(document.createTextNode(message));
      
      document.querySelector('.toast-container').appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    document.getElementById('slotBookingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitButton = e.target.querySelector('button[type="submit"]');
      submitButton.classList.add('loading');
      
      const formData = {
        name: document.getElementById('userName').value.trim(),
        dateRange: document.getElementById('dateRangeSelect').value,
        day: document.getElementById('daySelect').value,
        role: document.getElementById('roleSelect').value,
        number: document.getElementById('number').value.trim()
      };
      
      document.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('error');
        const errorMsg = group.querySelector('.error-message');
        if (errorMsg) errorMsg.remove();
      });
      
      let hasError = false;
      Object.entries(formData).forEach(([key, value]) => {
        if (!value) {
          const field = document.getElementById(key === 'name' ? 'userName' : key);
          const formGroup = field.closest('.form-group');
          formGroup.classList.add('error');
          
          const errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          errorMsg.innerHTML = `<i class="fas fa-exclamation-circle"></i> This field is required`;
          formGroup.appendChild(errorMsg);
          
          hasError = true;
        }
      });
      
      if (hasError) {
        submitButton.classList.remove('loading');
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      try {
        const slotRef = ref(db, `bookings/${formData.dateRange}/${formData.day}/${formData.role}`);
        const snapshot = await get(slotRef);
        const currentBookings = snapshot.exists() ? snapshot.val() : {};
        const maxSlots = formData.role === 'BlogPost' ? 1 : 3;
        if (Object.keys(currentBookings).length >= maxSlots) {
          showToast(`Maximum ${maxSlots} slot${maxSlots > 1 ? 's' : ''} filled`, 'warning');
          submitButton.classList.remove('loading');
          return;
        }
        const newBookingRef = push(slotRef);
        await set(newBookingRef, {
          name: formData.name,
          number: formData.number,
          date: formatDate(dateRanges[formData.dateRange].days[formData.day].date || 
                dateRanges[formData.dateRange].days[formData.day])
        });
        showToast('Slot booked successfully!', 'success');
        e.target.reset();
        displaySlots();
      } catch (error) {
        console.error('Error:', error);
        showToast('Booking failed. Please try again.', 'error');
      } finally {
        submitButton.classList.remove('loading');
      }
    });

    async function displaySlots() {
      const container = document.getElementById('slotAvailability');
      container.innerHTML = `
        <div class="firebase-loading">
          <div class="spinner"></div>
          <div class="message">Loading bookings data...</div>
        </div>
      `;
      try {
        const dateRangeKeys = Object.keys(dateRanges).sort();
        container.innerHTML = '';
        for (const range of dateRangeKeys) {
          const rangeRef = ref(db, 'bookings/' + range);
          const snapshot = await get(rangeRef);
          const data = snapshot.exists() ? snapshot.val() : {};
          const rangeDiv = document.createElement('div');
          const weekNumber = dateRangeKeys.indexOf(range) + 1;
          rangeDiv.innerHTML = `<h3>Week ${weekNumber}: ${range.replace('-', ' - ')}</h3>`;
          if (Object.keys(data).length === 0) {
            const noBookingsDiv = document.createElement('div');
            noBookingsDiv.className = 'no-bookings';
            noBookingsDiv.innerHTML = `
              <i class="far fa-calendar-times"></i>
              <span>No bookings yet for this period</span>
            `;
            rangeDiv.appendChild(noBookingsDiv);
          } else {
            Object.entries(data).forEach(([day, roles]) => {
              const slotItemDiv = document.createElement('div');
              slotItemDiv.className = 'slot-item';
              let rolesHTML = '';
              if (day === 'Sunday') {
                const postType = dateRanges[range].days[day].postType;
                rolesHTML += `<div class="post-type-badge">${postType.toUpperCase()} FORMAT</div>`;
              }
              if (day === 'Wednesday') {
                rolesHTML += `<div class="post-type-badge">BLOG POST</div>`;
              }
              Object.entries(roles).forEach(([role, bookings]) => {
                const roleBadgeClass = role.toLowerCase() === 'blogpost' ? 'blog' : 
                                     role.toLowerCase() === 'content' ? 'content' : 'design';
                Object.values(bookings).forEach(details => {
                  rolesHTML += `
                    <div class="slot-role">
                      <span class="category-badge ${roleBadgeClass}">${role}</span>
                      <a href="https://wa.me/${details.number}" 
                         target="_blank"
                         class="whatsapp-link"
                         title="Chat on WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                        ${details.name}
                      </a>
                    </div>
                  `;
                });
              });
              slotItemDiv.innerHTML = `
                <div class="slot-details">
                  <div class="slot-day">
                    ${day} 
                    <span class="slot-date">
                      (${formatDate(dateRanges[range].days[day].date || dateRanges[range].days[day])})
                    </span>
                  </div>
                  ${rolesHTML}
                </div>
              `;
              rangeDiv.appendChild(slotItemDiv);
            });
          }
          container.appendChild(rangeDiv);
        }
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `
          <div style="text-align: center; color: var(--error); padding: 2rem;">
            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Failed to load bookings. Please try again later.</p>
          </div>
        `;
      }
    }

    window.onload = async function() {
      await getCurrentActiveWeeks();
      displaySlots().catch(error => {
        console.error('Error loading slots:', error);
      });
      
      // Start the member countdown timer for main portal
      startMemberCountdownTimer();
    }

    // --- Routing and Admin Logic ---
    function showSection(section) {
      document.getElementById('mainPortal').style.display = section === 'main' ? '' : 'none';
      document.getElementById('adminLoginSection').style.display = section === 'adminLogin' ? 'flex' : 'none';
      document.getElementById('adminDashboardSection').style.display = section === 'adminDashboard' ? '' : 'none';
    }

    function route() {
      if (window.location.hash === '#/admin') {
        onAuthStateChanged(auth, (user) => {
          if (user && user.uid === 'GjBCSLAzhYXZmPGCiQjuYkiRdO63') {
            showSection('adminDashboard');
            loadAdminDashboard();
          } else {
            showSection('adminLogin');
          }
        });
      } else {
        showSection('main');
      }
    }

    window.addEventListener('hashchange', route);
    route();

    // --- Admin Login Logic ---
    const adminLoginForm = document.getElementById('adminLoginForm');
    if (adminLoginForm) {
      adminLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('adminEmail').value.trim();
        const password = document.getElementById('adminPassword').value;
        const btn = adminLoginForm.querySelector('button[type="submit"]');
        btn.classList.add('loading');
        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          if (userCredential.user.uid === 'GjBCSLAzhYXZmPGCiQjuYkiRdO63') {
            showToast('Login successful!', 'success');
            showSection('adminDashboard');
            loadAdminDashboard();
            window.location.hash = '#/admin';
          } else {
            await signOut(auth);
            showToast('Access denied: Not an admin.', 'error');
          }
        } catch (err) {
          showToast('Login failed: ' + (err.message || 'Invalid credentials'), 'error');
        } finally {
          btn.classList.remove('loading');
        }
      });
    }

    // --- Admin Logout ---
    const adminLogoutBtn = document.getElementById('adminLogoutBtn');
    if (adminLogoutBtn) {
      adminLogoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        showToast('Logged out.', 'info');
        showSection('adminLogin');
        window.location.hash = '#/admin';
      });
    }

    // --- Advance Week Button ---
    const advanceCycleBtn = document.getElementById('advanceCycleBtn');
    if (advanceCycleBtn) {
      advanceCycleBtn.addEventListener('click', async () => {
        console.log('Advance Week button clicked');
        console.log('Current week start before:', currentWeekStart);
        
        advanceCycleBtn.classList.add('loading');
        try {
          await advanceToNextWeek();
        } catch (error) {
          console.error('Error in advance week button:', error);
        } finally {
          advanceCycleBtn.classList.remove('loading');
        }
      });
    }

    // --- Hamburger Menu Functionality ---
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const navButtons = document.getElementById('navButtons');
    
    if (hamburgerBtn && navButtons) {
      hamburgerBtn.addEventListener('click', () => {
        navButtons.classList.toggle('show');
        
        // Change hamburger icon
        const icon = hamburgerBtn.querySelector('i');
        if (navButtons.classList.contains('show')) {
          icon.className = 'fas fa-times';
        } else {
          icon.className = 'fas fa-bars';
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!hamburgerBtn.contains(e.target) && !navButtons.contains(e.target)) {
          navButtons.classList.remove('show');
          const icon = hamburgerBtn.querySelector('i');
          icon.className = 'fas fa-bars';
        }
      });
      
      // Close menu when a navigation button is clicked
      const navButtonElements = navButtons.querySelectorAll('button');
      navButtonElements.forEach(button => {
        button.addEventListener('click', () => {
          navButtons.classList.remove('show');
          const icon = hamburgerBtn.querySelector('i');
          icon.className = 'fas fa-bars';
        });
      });
    }

    // --- Admin Dashboard Navigation ---
    const navMembers = document.getElementById('navMembers');
    const navAssign = document.getElementById('navAssign');
    const navAutoAssign = document.getElementById('navAutoAssign');
    if (navMembers && navAssign && navAutoAssign) {
      navMembers.addEventListener('click', () => {
        document.getElementById('adminMembersSection').style.display = 'block';
        document.getElementById('adminAssignSection').style.display = 'none';
        document.getElementById('adminAutoAssignSection').style.display = 'none';
        navMembers.style.background = 'var(--primary-gradient)';
        navMembers.style.color = 'white';
        navAssign.style.background = 'var(--surface-light)';
        navAssign.style.color = 'var(--text)';
        navAutoAssign.style.background = 'var(--surface-light)';
        navAutoAssign.style.color = 'var(--text)';
      });
      navAssign.addEventListener('click', () => {
        document.getElementById('adminMembersSection').style.display = 'none';
        document.getElementById('adminAssignSection').style.display = 'block';
        document.getElementById('adminAutoAssignSection').style.display = 'none';
        navAssign.style.background = 'var(--primary-gradient)';
        navAssign.style.color = 'white';
        navMembers.style.background = 'var(--surface-light)';
        navMembers.style.color = 'var(--text)';
        navAutoAssign.style.background = 'var(--surface-light)';
        navAutoAssign.style.color = 'var(--text)';
        // Load assign tasks only when tab is clicked
        loadAssignTasks();
      });
      navAutoAssign.addEventListener('click', () => {
        document.getElementById('adminMembersSection').style.display = 'none';
        document.getElementById('adminAssignSection').style.display = 'none';
        document.getElementById('adminAutoAssignSection').style.display = 'block';
        navAutoAssign.style.background = 'var(--primary-gradient)';
        navAutoAssign.style.color = 'white';
        navMembers.style.background = 'var(--surface-light)';
        navMembers.style.color = 'var(--text)';
        navAssign.style.background = 'var(--surface-light)';
        navAssign.style.color = 'var(--text)';
      });
    }

    // --- Members List Logic ---
    async function loadMembers() {
      const contentTeamList = document.getElementById('contentTeamList');
      const designTeamList = document.getElementById('designTeamList');
      contentTeamList.innerHTML = '';
      designTeamList.innerHTML = '';
      try {
        const membersSnap = await get(ref(db, 'members'));
        const members = membersSnap.exists() ? membersSnap.val() : {};
        const content = members.contentTeam || {};
        const design = members.designTeam || {};
        for (const [key, member] of Object.entries(content)) {
          const li = document.createElement('li');
          li.style.marginBottom = '1rem';
          li.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.2rem;"><span style="font-weight:600;">${member.name}</span><span style="color:var(--text-muted);font-size:0.95em;">${member.number}</span></div>`;
          contentTeamList.appendChild(li);
        }
        for (const [key, member] of Object.entries(design)) {
          const li = document.createElement('li');
          li.style.marginBottom = '1rem';
          li.innerHTML = `<div style="display:flex;flex-direction:column;gap:0.2rem;"><span style="font-weight:600;">${member.name}</span><span style="color:var(--text-muted);font-size:0.95em;">${member.number}</span></div>`;
          designTeamList.appendChild(li);
        }
      } catch (err) {
        showToast('Failed to load members', 'error');
      }
    }

    // --- Add Member Logic ---
    const addMemberForm = document.getElementById('addMemberForm');
    if (addMemberForm) {
      addMemberForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('memberName').value.trim();
        const number = document.getElementById('memberNumber').value.trim();
        const team = document.getElementById('memberTeam').value;
        const btn = addMemberForm.querySelector('button[type="submit"]');
        btn.classList.add('loading');
        try {
          if (!name || !number || !team) throw new Error('All fields required');
          await push(ref(db, `members/${team}`), { name, number });
          showToast('Member added!', 'success');
          addMemberForm.reset();
          loadMembers();
        } catch (err) {
          showToast('Failed to add member', 'error');
        } finally {
          btn.classList.remove('loading');
        }
      });
    }

    // --- Assign Tasks Logic ---
    async function loadAssignTasks() {
      const assignTasksList = document.getElementById('assignTasksList');
      assignTasksList.innerHTML = '';
      // Load members
      let members = { contentTeam: {}, designTeam: {} };
      try {
        const membersSnap = await get(ref(db, 'members'));
        if (membersSnap.exists()) members = membersSnap.val();
      } catch {}
      // Load bookings
      let bookings = {};
      try {
        const bookingsSnap = await get(ref(db, 'bookings'));
        if (bookingsSnap.exists()) bookings = bookingsSnap.val();
      } catch {}
      // For each dateRange and day/role
      const weekKeys = Object.keys(dateRanges).sort();
      weekKeys.forEach((rangeKey, i) => {
        const rangeObj = dateRanges[rangeKey];
        const weekDiv = document.createElement('div');
        weekDiv.style.marginBottom = '2rem';
        weekDiv.innerHTML = `<h3>Week ${i+1}: ${rangeKey.replace('-', ' - ')}</h3>`;
        // Collect all slot divs for this week
        const slots = [];
        Object.entries(rangeObj.days).forEach(([day, dayObj]) => {
          let roles = [];
          if (day === 'Sunday') {
            roles = ['Content', 'Design'];
          } else if (day === 'Wednesday') {
            roles = ['BlogPost'];
          }
          roles.forEach(role => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'slot-item';
            slotDiv.style.flexDirection = 'column';
            slotDiv.style.alignItems = 'flex-start';
            // Show assigned members with delete buttons
            let assigned = (bookings?.[rangeKey]?.[day]?.[role] ? Object.entries(bookings[rangeKey][day][role]) : []);
            let assignedHTML = '';
            if (assigned.length > 0) {
              assignedHTML = assigned.map(([bookingKey, m]) => `
                <div style="margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem;justify-content:space-between;background:rgba(255,255,255,0.05);padding:0.5rem;border-radius:6px;">
                  <div>
                    <span style="font-weight:600;">${m.name}</span> 
                    <span style="color:var(--text-muted);font-size:0.95em;">${m.number}</span>
                  </div>
                  <button type="button" 
                    class="delete-booking-btn" 
                    data-range="${rangeKey}" 
                    data-day="${day}" 
                    data-role="${role}" 
                    data-booking-key="${bookingKey}"
                    data-member-name="${m.name}"
                    style="background:var(--error);color:white;border:none;border-radius:4px;padding:0.25rem 0.5rem;font-size:0.8rem;cursor:pointer;transition:var(--transition);">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              `).join('');
            } else {
              assignedHTML = '<span style="color:var(--text-muted);">No one assigned yet</span>';
            }
            // Member dropdown
            let teamType = (role === 'Design') ? 'designTeam' : 'contentTeam';
            let memberEntries = Object.entries(members[teamType] || {});
            let memberOptions = '';
            const maxSlots = role === 'BlogPost' ? 1 : 3;
            let canAssign = assigned.length < maxSlots && memberEntries.length > 0;
            if (memberEntries.length > 0) {
              memberOptions = memberEntries.map(([k, m]) => `<option value="${k}">${m.name} (${m.number})</option>`).join('');
            } else {
              memberOptions = '<option value="" disabled selected>No members available</option>';
            }
            slotDiv.innerHTML = `
              <div style="display:flex;align-items:center;gap:1rem;">
                <div style="font-weight:600;">${day} (${formatDate(dayObj.date || dayObj)})</div>
                <span class="category-badge ${role.toLowerCase() === 'blogpost' ? 'blog' : role.toLowerCase() === 'content' ? 'content' : 'design'}">${role}</span>
              </div>
              <div style="margin:0.5rem 0 0.5rem 0;">${assignedHTML}</div>
              <form class="assignForm" data-range="${rangeKey}" data-day="${day}" data-role="${role}" style="display:flex;gap:0.5rem;align-items:center;">
                <select required name="memberKey" style="padding:0.5rem 1rem;border-radius:6px;">
                  <option value="" disabled selected>Select member</option>
                  ${memberOptions}
                </select>
                <button type="submit" ${canAssign ? '' : 'disabled'} style="background:var(--primary-gradient);color:white;border:none;border-radius:6px;padding:0.5rem 1.2rem;font-weight:600;cursor:pointer;">Assign</button>
              </form>
            `;
            slots.push(slotDiv);
          });
        });
        // Append week heading, then all slots for this week
        assignTasksList.appendChild(weekDiv);
        slots.forEach(slotDiv => assignTasksList.appendChild(slotDiv));
      });
      // Assign form submit
      assignTasksList.querySelectorAll('.assignForm').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button[type="submit"]');
          btn.classList.add('loading');
          const range = form.getAttribute('data-range');
          const day = form.getAttribute('data-day');
          const role = form.getAttribute('data-role');
          const memberKey = form.memberKey.value;
          let teamType = (role === 'Design') ? 'designTeam' : 'contentTeam';
          const member = members[teamType]?.[memberKey];
          if (!member) {
            showToast('Select a valid member', 'error');
            btn.classList.remove('loading');
            return;
          }
          try {
            // Get current bookings for this slot
            const slotRef = ref(db, `bookings/${range}/${day}/${role}`);
            const snap = await get(slotRef);
            let current = snap.exists() ? snap.val() : {};
            const maxSlots = role === 'BlogPost' ? 1 : 3;
            if (Object.keys(current).length >= maxSlots) {
              showToast(`Maximum ${maxSlots} slot${maxSlots > 1 ? 's' : ''} filled`, 'warning');
              btn.classList.remove('loading');
              return;
            }
            await push(slotRef, {
              name: member.name,
              number: member.number,
              date: formatDate(dateRanges[range].days[day].date || dateRanges[range].days[day])
            });
            showToast('Assigned!', 'success');
            loadAssignTasks();
            displaySlots(); // update main portal if open
          } catch (err) {
            showToast('Failed to assign', 'error');
          } finally {
            btn.classList.remove('loading');
          }
        });
      });

      // Delete booking buttons
      assignTasksList.querySelectorAll('.delete-booking-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          
          // Confirm deletion
          const memberName = btn.getAttribute('data-member-name');
          const range = btn.getAttribute('data-range');
          const day = btn.getAttribute('data-day');
          const role = btn.getAttribute('data-role');
          const bookingKey = btn.getAttribute('data-booking-key');
          
          if (!confirm(`Are you sure you want to remove ${memberName} from ${day} (${range})?`)) {
            return;
          }
          
          btn.classList.add('loading');
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          
          try {
            // Delete the specific booking
            const bookingRef = ref(db, `bookings/${range}/${day}/${role}/${bookingKey}`);
            await set(bookingRef, null); // Set to null to delete
            
            showToast(`Removed ${memberName} from ${day}`, 'success');
            loadAssignTasks(); // Reload the list
            displaySlots(); // Update main portal if open
          } catch (err) {
            console.error('Error deleting booking:', err);
            showToast('Failed to remove booking', 'error');
            btn.innerHTML = '<i class="fas fa-trash"></i>';
          } finally {
            btn.classList.remove('loading');
          }
        });
      });
    }

    // --- Load Admin Dashboard ---
    async function loadAdminDashboard() {
      // Default to Members tab
      document.getElementById('adminMembersSection').style.display = 'block';
      document.getElementById('adminAssignSection').style.display = 'none';
      document.getElementById('adminAutoAssignSection').style.display = 'none';
      navMembers.style.background = 'var(--primary-gradient)';
      navMembers.style.color = 'white';
      navAssign.style.background = 'var(--surface-light)';
      navAssign.style.color = 'var(--text)';
      navAutoAssign.style.background = 'var(--surface-light)';
      navAutoAssign.style.color = 'var(--text)';
      await getCurrentActiveWeeks();
      loadMembers();
      // Don't load assign tasks here - only load when tab is clicked
      
      // Start the auto-assign timer
      startAutoAssignTimer();
    }

    // --- Auto-Assign Tab Logic ---
    const autoDateRange = document.getElementById('autoDateRange');
    const autoDay = document.getElementById('autoDay');
    const autoRole = document.getElementById('autoRole');
    if (autoDateRange) {
      autoDateRange.addEventListener('change', function(e) {
        const rangeKey = e.target.value;
        autoDay.innerHTML = '<option value="" disabled selected>Choose day</option>';
        autoRole.innerHTML = '<option value="" disabled selected>Select role</option>';
        const range = dateRanges[rangeKey];
        for (const [dayName, dayData] of Object.entries(range.days)) {
          const option = document.createElement('option');
          option.value = dayName;
          if (dayName === 'Sunday') {
            option.textContent = `${dayName} (${formatDate(dayData.date)}) - ${dayData.postType.toUpperCase()}`;
          } else {
            option.textContent = `${dayName} (${formatDate(dayData)})`;
          }
          autoDay.appendChild(option);
        }
      });
    }
    if (autoDay) {
      autoDay.addEventListener('change', function(e) {
        autoRole.innerHTML = '<option value="" disabled selected>Select role</option>';
        if (e.target.value === 'Sunday') {
          autoRole.innerHTML = `
            <option value="Content">Content (3 slots)</option>
            <option value="Design">Design (3 slots)</option>
          `;
        } else if (e.target.value === 'Wednesday') {
          autoRole.innerHTML = `
            <option value="BlogPost">Blog Post Writer (1 slot)</option>
          `;
        }
      });
    }
    const autoAssignForm = document.getElementById('autoAssignForm');
    if (autoAssignForm) {
      autoAssignForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = autoAssignForm.querySelector('button[type="submit"]');
        submitBtn.classList.add('loading');
        const range = autoDateRange.value;
        const day = autoDay.value;
        const role = autoRole.value;
        if (!range || !day || !role) {
          showToast('Please select all fields', 'error');
          submitBtn.classList.remove('loading');
          return;
        }
        try {
          // Fetch members
          let teamType = (role === 'Design') ? 'designTeam' : (role === 'Content' ? 'contentTeam' : 'contentTeam');
          const membersSnap = await get(ref(db, `members/${teamType}`));
          const members = membersSnap.exists() ? membersSnap.val() : {};
          // Fetch current bookings
          const slotRef = ref(db, `bookings/${range}/${day}/${role}`);
          const bookingsSnap = await get(slotRef);
          const currentBookings = bookingsSnap.exists() ? bookingsSnap.val() : {};
          const alreadyAssignedNumbers = new Set(Object.values(currentBookings).map(m => m.number));
          // Filter unassigned members
          const unassigned = Object.values(members).filter(m => !alreadyAssignedNumbers.has(m.number));
          // How many to assign?
          const maxSlots = role === 'BlogPost' ? 1 : 3;
          const toAssign = maxSlots - Object.keys(currentBookings).length;
          if (toAssign <= 0) {
            showToast('All slots already filled', 'warning');
            submitBtn.classList.remove('loading');
            return;
          }
          if (unassigned.length === 0) {
            showToast('No unassigned members available', 'warning');
            submitBtn.classList.remove('loading');
            return;
          }
          
          // Check for people who worked in the previous week and prevent same group formation from ALL previous weeks
          let availableMembers = unassigned;
          let allPreviousGroups = [];
          let lastWeekWorkers = new Set();
          
          try {
            // Get all bookings to find the previous week and collect ALL previous groups
            const allBookingsRef = ref(db, 'bookings');
            const allBookingsSnapshot = await get(allBookingsRef);
            
            if (allBookingsSnapshot.exists()) {
              const allBookings = allBookingsSnapshot.val();
              
              // Sort weeks chronologically by parsing the dates
              const allWeekKeys = Object.keys(allBookings).sort((a, b) => {
                // Parse week keys like "Aug4-Aug10" to get start dates
                const parseWeekStart = (weekKey) => {
                  const match = weekKey.match(/([A-Za-z]+)(\d+)/);
                  if (!match) return new Date(0);
                  
                  const month = match[1];
                  const day = parseInt(match[2]);
                  const year = 2025; // You can make this dynamic
                  
                  const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                  };
                  
                  return new Date(year, monthMap[month], day);
                };
                
                const dateA = parseWeekStart(a);
                const dateB = parseWeekStart(b);
                return dateA - dateB;
              });
              
              const currentWeekIndex = allWeekKeys.indexOf(range);
              
              if (currentWeekIndex > 0) { // If not the first week ever, check previous weeks
                // Get the immediate previous week for break logic
                const previousWeek = allWeekKeys[currentWeekIndex - 1];
                console.log(`Current week: ${range}, Previous week: ${previousWeek}`); // Debug log
                
                // Collect groups from ALL previous weeks (not just the immediate previous week)
                for (let i = 0; i < currentWeekIndex; i++) {
                  const pastWeek = allWeekKeys[i];
                  const pastWeekBookings = allBookings[pastWeek];
                  
                  Object.entries(pastWeekBookings).forEach(([day, dayData]) => {
                    Object.entries(dayData).forEach(([role, roleData]) => {
                      const groupMembers = Object.values(roleData);
                      if (groupMembers.length > 0) {
                        // Store the group from any previous week
                        allPreviousGroups.push({
                          members: groupMembers,
                          day: day,
                          role: role,
                          week: pastWeek
                        });
                        
                        // Only add to lastWeekWorkers if it's the immediate previous week
                        if (pastWeek === previousWeek) {
                          groupMembers.forEach(member => {
                            lastWeekWorkers.add(member.number);
                            console.log(`Found worker from previous week: ${member.name} (${member.number})`); // Debug log
                          });
                        }
                      }
                    });
                  });
                }
                
                console.log(`Found ${allPreviousGroups.length} groups from all previous weeks`);
                
                // Filter out people who worked in the previous week (for break logic)
                availableMembers = unassigned.filter(m => !lastWeekWorkers.has(m.number));
                console.log(`Available members after filtering: ${availableMembers.map(m => m.name).join(', ')}`); // Debug log
                
                if (availableMembers.length === 0) {
                  showToast('All available members worked last week. No breaks possible.', 'warning');
                  submitBtn.classList.remove('loading');
                  return;
                }
                
                // Prevent same group formation from ALL previous weeks
                if (availableMembers.length >= toAssign && allPreviousGroups.length > 0) {
                  // Find groups from the same day and role in ANY previous week
                  const sameDayRoleGroups = allPreviousGroups.filter(group => group.day === day && group.role === role);
                  
                  if (sameDayRoleGroups.length > 0) {
                    console.log(`Found ${sameDayRoleGroups.length} previous groups for same day/role`);
                    
                    // Collect all members from all previous groups for this day/role
                    const allPreviousGroupMembers = new Set();
                    sameDayRoleGroups.forEach(group => {
                      group.members.forEach(member => {
                        allPreviousGroupMembers.add(member.number);
                      });
                    });
                    
                    // Try to form a completely different group
                    const availableForDifferentGroup = availableMembers.filter(m => !allPreviousGroupMembers.has(m.number));
                    
                    if (availableForDifferentGroup.length >= toAssign) {
                      console.log(`Preventing same group formation from all previous weeks. Using different members: ${availableForDifferentGroup.map(m => m.name).join(', ')}`);
                      availableMembers = availableForDifferentGroup;
                    } else {
                      console.log(`Not enough members for completely different group, using all available: ${availableMembers.map(m => m.name).join(', ')}`);
                    }
                  }
                }
              }
            }
          } catch (err) {
            console.error('Error checking previous week bookings:', err);
          }
          
          // Randomly pick members
          const shuffled = availableMembers.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, toAssign);
          // Assign them
          for (const member of selected) {
            await push(slotRef, {
              name: member.name,
              number: member.number,
              date: formatDate(dateRanges[range].days[day].date || dateRanges[range].days[day])
            });
          }
          showToast('Auto-assigned successfully!', 'success');
          // Show result
          const allBookingsSnap = await get(slotRef);
          const allBookings = allBookingsSnap.exists() ? allBookingsSnap.val() : {};
          let resultHTML = `<h4>Assigned Members:</h4>`;
          resultHTML += Object.values(allBookings).map(m => `<div style="margin-bottom:0.2rem;"><span style="font-weight:600;">${m.name}</span> <span style="color:var(--text-muted);font-size:0.95em;">${m.number}</span></div>`).join('');
          document.getElementById('autoAssignResult').innerHTML = resultHTML;
          loadAssignTasks();
          displaySlots();
        } catch (err) {
          showToast('Auto-assign failed', 'error');
        } finally {
          submitBtn.classList.remove('loading');
        }
      });
    }
  </script>
  
  <script>
    const STAR_COLOR = '#fff';
    const STAR_SIZE = 2;
    const STAR_MIN_SCALE = 0.2;
    const OVERFLOW_THRESHOLD = 50;
    const STAR_COUNT = (window.innerWidth + window.innerHeight) / 10;
    
    const canvas = document.querySelector('canvas'),
          context = canvas.getContext('2d');
    
    let scale = 1,
        width,
        height;
    
    let stars = [];
    let pointerX, pointerY;
    let velocity = { x: 0, y: 0, tx: 0, ty: 0, z: 0.0003 };
    let touchInput = false;
    
    function generate() {
      for (let i = 0; i < STAR_COUNT; i++) {
        stars.push({
          x: 0,
          y: 0,
          z: STAR_MIN_SCALE + Math.random() * (1 - STAR_MIN_SCALE)
        });
      }
    }
    
    function placeStar(star) {
      star.x = Math.random() * width;
      star.y = Math.random() * height;
    }
    
    function recycleStar(star) {
      let direction = 'z';
      let vx = Math.abs(velocity.x),
          vy = Math.abs(velocity.y);
    
      if (vx > 1 || vy > 1) {
        let axis;
        if (vx > vy) {
          axis = Math.random() < vx / (vx + vy) ? 'h' : 'v';
        } else {
          axis = Math.random() < vy / (vx + vy) ? 'v' : 'h';
        }
    
        if (axis === 'h') {
          direction = velocity.x > 0 ? 'l' : 'r';
        } else {
          direction = velocity.y > 0 ? 't' : 'b';
        }
      }
      
      star.z = STAR_MIN_SCALE + Math.random() * (1 - STAR_MIN_SCALE);
    
      if (direction === 'z') {
        star.z = 0.1;
        star.x = Math.random() * width;
        star.y = Math.random() * height;
      } else if (direction === 'l') {
        star.x = -OVERFLOW_THRESHOLD;
        star.y = height * Math.random();
      } else if (direction === 'r') {
        star.x = width + OVERFLOW_THRESHOLD;
        star.y = height * Math.random();
      } else if (direction === 't') {
        star.x = width * Math.random();
        star.y = -OVERFLOW_THRESHOLD;
      } else if (direction === 'b') {
        star.x = width * Math.random();
        star.y = height + OVERFLOW_THRESHOLD;
      }
    }
    
    function resize() {
      scale = window.devicePixelRatio || 1;
      width = window.innerWidth * scale;
      height = window.innerHeight * scale;
      canvas.width = width;
      canvas.height = height;
      stars.forEach(placeStar);
    }
    
    function step() {
      context.clearRect(0, 0, width, height);
      update();
      render();
      requestAnimationFrame(step);
    }
    
    function update() {
      velocity.tx *= 0.95;
      velocity.ty *= 0.95;
      velocity.x += (velocity.tx - velocity.x) * 0.8;
      velocity.y += (velocity.ty - velocity.y) * 0.8;
    
      stars.forEach((star) => {
        star.x += velocity.x * star.z;
        star.y += velocity.y * star.z;
        star.x += (star.x - width / 2) * velocity.z * star.z;
        star.y += (star.y - height / 2) * velocity.z * star.z;
        star.z += velocity.z;
    
        if (
          star.x < -OVERFLOW_THRESHOLD ||
          star.x > width + OVERFLOW_THRESHOLD ||
          star.y < -OVERFLOW_THRESHOLD ||
          star.y > height + OVERFLOW_THRESHOLD
        ) {
          recycleStar(star);
        }
      });
    }
    
    function render() {
      stars.forEach((star) => {
        context.beginPath();
        context.lineCap = 'round';
        context.lineWidth = STAR_SIZE * star.z * scale;
        context.globalAlpha = 0.5 + 0.5 * Math.random();
        
        const hue = 210 + Math.random() * 30;
        context.strokeStyle = `hsl(${hue}, 80%, 80%)`;
        
        context.beginPath();
        context.moveTo(star.x, star.y);
    
        let tailX = velocity.x * 2,
            tailY = velocity.y * 2;
    
        if (Math.abs(tailX) < 0.1) tailX = 0.5;
        if (Math.abs(tailY) < 0.1) tailY = 0.5;
    
        context.lineTo(star.x + tailX, star.y + tailY);
        context.stroke();
      });
    }
    
    function movePointer(x, y) {
      if (typeof pointerX === 'number' && typeof pointerY === 'number') {
        let ox = x - pointerX,
            oy = y - pointerY;
        velocity.tx = velocity.tx + (ox / (8 * scale)) * (touchInput ? 1 : -1);
        velocity.ty = velocity.ty + (oy / (8 * scale)) * (touchInput ? 1 : -1);
      }
      pointerX = x;
      pointerY = y;
    }
    
    function onMouseMove(event) {
      touchInput = false;
      movePointer(event.clientX, event.clientY);
    }
    
    function onTouchMove(event) {
      touchInput = true;
      movePointer(event.touches[0].clientX, event.touches[0].clientY, true);
      event.preventDefault();
    }
    
    function onMouseLeave() {
      pointerX = null;
      pointerY = null;
    }
    
    generate();
    resize();
    step();
    
    window.onresize = resize;
    canvas.onmousemove = onMouseMove;
    canvas.ontouchmove = onTouchMove;
    canvas.ontouchend = onMouseLeave;
    document.onmouseleave = onMouseLeave;
  </script>
</body>
</html>